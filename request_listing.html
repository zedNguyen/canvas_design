<!DOCTYPE html>
<html lang="ko">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>요청 목록</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <meta name="robots" content="noindex,nofollow" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Global site tag (gtag.js) - Google Analytics PROD만 동작 -->

  <link href="./저장위치 관리_files/bootstrap.min.css" rel="stylesheet" />
  <link href="./저장위치 관리_files/perfect-scrollbar.min.css" rel="stylesheet" />

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <link href="./저장위치 관리_files/jquery.bootstrap-touchspin.min.css" rel="stylesheet" />

  <link href="./저장위치 관리_files/style.css" rel="stylesheet" />
  <link href="./저장위치 관리_files/jquery-ui.min.css" rel="stylesheet" />

  <link rel="stylesheet" href="./저장위치 관리_files/pinejs.css" />

  <link href="./저장위치 관리_files/ag-grid.min.css" rel="stylesheet" />
  <link href="./저장위치 관리_files/ag-theme-balham.min.css" rel="stylesheet" />
  <link href="./저장위치 관리_files/aggrid.css" rel="stylesheet" />

  <link href="./저장위치 관리_files/toastr.css" rel="stylesheet" />

  <link href="./저장위치 관리_files/blue.css" id="theme" rel="stylesheet" />

  <!-- Harmony Blue & custom styles for /learn pages -->
  <link href="./style.css" rel="stylesheet" />
  <link href="./저장위치 관리_files/custom.css" rel="stylesheet" />

  <script src="./저장위치 관리_files/jquery.min.js.download"></script>

  <script src="./저장위치 관리_files/popper.min.js.download"></script>
  <script src="./저장위치 관리_files/bootstrap.min.js.download"></script>

  <script src="./저장위치 관리_files/perfect-scrollbar.jquery.min.js.download"></script>

  <script src="./저장위치 관리_files/waves.js.download"></script>

  <script src="./저장위치 관리_files/sidebarmenu.js.download"></script>
  <!-- <script th:src="@{/plugins/pinejs/js/adminpro.js}"></script> -->

  <script src="./저장위치 관리_files/adminpro.js.download"></script>

  <script src="./저장위치 관리_files/jquery.toast.js.download"></script>

  <script src="./저장위치 관리_files/jquery.serializeObject.min.js.download"></script>

  <script src="./저장위치 관리_files/jquery.validate.min.js.download"></script>
  <script src="./저장위치 관리_files/messages_ko.js.download"></script>

  <script src="./저장위치 관리_files/jquery-ui.min.js.download"></script>
  <script src="./저장위치 관리_files/numeral.min.js.download"></script>
  <script src="./저장위치 관리_files/lodash.4.17.15.min.js.download"></script>
  <script src="./저장위치 관리_files/moment.js.download"></script>

  <script src="./저장위치 관리_files/jquery.collapse.js.download"></script>

  <script src="./저장위치 관리_files/jquery.bootstrap-touchspin.min.js.download"></script>
  <!-- bootstrap submodal -->
  <script src="./저장위치 관리_files/bs.sm.js.download"></script>

  <script src="./저장위치 관리_files/xlsx.full.min.js.download"></script>
  <script src="./저장위치 관리_files/fileSaver.min.js.download"></script>
  <script src="./저장위치 관리_files/toastr.min.js.download"></script>

  <script src="./저장위치 관리_files/jquery.mask.js.download"></script>

  <script src="./저장위치 관리_files/ag-grid-enterprise.min.noStyle.js.download"></script>
  <script>
    agGrid.LicenseManager.setLicenseKey(
      "CompanyName=JSIT,LicensedGroup=HANSOL PNS IT-SERVICE,LicenseType=MultipleApplications,LicensedConcurrentDeveloperCount=3,LicensedProductionInstancesCount=2,AssetReference=AG-008218,ExpiryDate=21_May_2021_[v2]_MTYyMTU1MTYwMDAwMA==fb098f15da774457685846b99c4a3a7e"
    );
  </script>
  <script src="./저장위치 관리_files/ag_base.js.download"></script>
  <script src="./저장위치 관리_files/ag_locale_ko.js.download"></script>
  <script src="./저장위치 관리_files/ag_renderer.js.download"></script>
  <script src="./저장위치 관리_files/ag_formatter.js.download"></script>
  <script src="./저장위치 관리_files/ag_editor.js.download"></script>
  <script src="./저장위치 관리_files/ag_excel.js.download"></script>

  <!-- CK Editor -->
  <!-- ============================================================== -->
  <script src="./저장위치 관리_files/ckeditor.js.download"></script>
  <style>
    .cke {
      visibility: hidden;
    }
  </style>

  <script src="./저장위치 관리_files/pine.js.download"></script>
  <script src="./저장위치 관리_files/global-val.js.download"></script>
  <script src="./저장위치 관리_files/core.js.download"></script>
  <script src="./저장위치 관리_files/file.js.download"></script>
  <script src="./저장위치 관리_files/auth.js.download"></script>
  <script src="./저장위치 관리_files/editor.js.download"></script>
  <script src="./저장위치 관리_files/aggridHelper.js.download"></script>

  <!-- ============================================================== -->

  <script src="./저장위치 관리_files/doc_ready.js.download"></script>
</head>

<body class="fix-header card-no-border main">
  <div class="preloader" style="display: none">
    <div class="loader">
      <div class="loader__figure"></div>
      <p class="loader__label">Harmony</p>
    </div>
  </div>

  <div id="main-wrapper">
    <header class="topbar">
      <nav class="navbar top-navbar navbar-expand-md navbar-light">
        <div class="navbar-header">
          <a class="navbar-brand">
            <b>
              <img src="./저장위치 관리_files/logo-icon.png" alt="homepage" class="dark-logo" />

              <img src="./저장위치 관리_files/logo-light-icon.png" alt="homepage" class="light-logo" />
            </b>

            <span>
              <img src="./저장위치 관리_files/logo-text.png" alt="homepage" class="dark-logo" />

              <img src="./저장위치 관리_files/logo-light-text.png" class="light-logo" alt="homepage" /></span>
          </a>
        </div>

        <div class="navbar-collapse">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link nav-toggler hidden-md-up waves-effect waves-dark" href="javascript:void(0)"><i
                  class="ti-menu"></i></a>
            </li>
            <li class="nav-item">
              <a class="nav-link sidebartoggler hidden-sm-down waves-effect waves-dark" href="javascript:void(0)"><i
                  class="fa-solid fa-bars"></i></a>
            </li>
          </ul>

          <ul class="navbar-nav my-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="javascript:void(0)">
                <span style="font-weight: bold; font-size: 18px">dev서버</span>
              </a>
            </li>

            <li class="nav-item hidden-xs-down search-box">
              <a class="nav-link hidden-sm-down waves-effect waves-dark" href="javascript:void(0)" title="메뉴 검색"><i
                  class="ti-search"></i></a>
              <form class="app-search" onsubmit="return false">
                <input type="text" id="menu-search-txt" class="form-control" placeholder="메뉴 검색" />
                <a class="srh-btn"><i class="ti-close"></i></a>
                <div id="menu-search" class="search-rslt"></div>
              </form>
            </li>

            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle waves-effect waves-dark" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                <span>시스템관리</span>
              </a>
              <div class="dropdown-menu dropdown-menu-right animated flipInY">
                <ul class="dropdown-user">
                  <li>
                    <div class="dw-user-box">
                      <div class="u-text">
                        <h4>
                          <i class="fas fa-user"></i>&nbsp;
                          <span>시스템관리</span>
                        </h4>
                        <p class="text-muted"><span></span></p>
                      </div>
                    </div>
                  </li>
                  <li role="separator" class="divider"></li>
                  <li>
                    <a><i class="ti-settings"></i> 계정설정</a>
                  </li>
                  <li role="separator" class="divider"></li>
                  <li>
                    <a><i class="fa fa-power-off"></i> 로그아웃</a>
                  </li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
      </nav>
    </header>
    <aside class="left-sidebar">
      <div class="scroll-sidebar ps-container ps-theme-default" data-ps-id="6445c0c0-d75d-a3cd-4fab-49cc73438c65">
        <nav class="sidebar-nav active">
          <ul id="sidebarnav" class="in">
            <li class="nav-small-cap">즐겨찾기 ★</li>
            <ul class="list-group" id="sidebarnav-favorite"></ul>
            <li class="nav-devider"></li>

            <li class="nav-small-cap">프로그램</li>

            <li class="active">
              <a class="has-arrow waves-effect waves-dark" aria-expanded="true">
                <i class="mdi mdi-format-list-bulleted"></i>
                <span class="hide-menu">Request</span>
              </a>

              <ul aria-expanded="true" class="collapse in show">
                <li style="margin-left: 14px;">
                  <a class=" waves-effect waves-dark" href="./request_popup.html">Popup Request
                    Demo</a>
                </li>
                <li style="margin-left: 14px;">
                  <a class=" waves-effect waves-dark" href="./request_listing.html " style="color: #007bff;">Request
                    listing Demo</a>
                </li>

              </ul>
            </li>
          </ul>
        </nav>
        <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px">
          <div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px"></div>
        </div>
        <div class="ps-scrollbar-y-rail" style="top: 0px; right: 3px">
          <div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 0px"></div>
        </div>
      </div>
    </aside>

    <div class="page-wrapper" style="min-height: 952px">
      <div class="container-fluid r-aside">
        <div class="row page-titles m-b-10">
          <div class="col-md-5 align-self-center">
            <!-- <h4 class="text-themecolor"><i class="fas fa-sticky-note pageIcon"></i><span id="pageTitles">HOME</span></h3> -->
            <!-- <h6 class="text-themecolor" id="pageTitleText">HOME</h5> -->
            <li id="pageTitleText">
              팝업 요청 목록<i class="fa-regular fa-star" style="
                    font-size: 16px !important;
                    font-weight: bold !important;
                    margin-left: 5px;
                  " data-favo="N"></i>
            </li>
          </div>
        </div>

        <div class="card" style="margin-bottom: 0px;" data-collapse="">
          <div class="card-header field-header open" data-collapse-summary="" aria-expanded="true">
            <a>
              <a class="card-link" aria-expanded="true" aria-controls="cardBody">검색조건
                <span class="expanded">
                  <p><b>▼</b></p>
                </span>
              </a>
            </a>
          </div>
          <div id="cardBody" class="collapse show field-body" aria-hidden="false">
            <div class="card-body pl-0">
              <div class="row">
                <div class="col-4 d-flex align-items-center">
                  <label for="filter-prod-from">기간</label>
                  <input type="date" id="filter-prod-from" name="filter-prod-from" class="form-control form-control-sm"
                    style="width: 33%" placeholder="YYYY-MM-DD" />
                  <span style="margin: 0 2px">~</span>
                  <input type="date" id="filter-prod-to" name="filter-prod-to" class="form-control form-control-sm"
                    style="width: 33%" placeholder="YYYY-MM-DD" />
                  <input type="checkbox" id="filter-all" checked class="ml-1"
                    style="vertical-align:middle; display: none;" />
                </div>


                <button id="btn-print" class="btn btn-harmony-blue btn-sm">
                  <i class="fa fa-search"></i> 검색
                </button>
              </div>
            </div>
          </div>
        </div>



        <!-- Tabs for request types -->
        <ul class="nav nav-tabs mb-3" id="requestTabs" role="tablist">

          <li class="nav-item">
            <a class="nav-link active" id="tab-approve" data-toggle="tab" href="#tabApprove" role="tab">결재함</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="tab-sent" data-toggle="tab" href="#tabSent" role="tab">상신함</a>
          </li>
        </ul>
        <div class="tab-content" id="requestTabContent">

          <div class="tab-pane fade show active" id="tabApprove" role="tabpanel">
            <div id="agGridApprove" class="ag-theme-balham" style="height:400px;width:100%;"></div>
          </div>
          <div class="tab-pane fade" id="tabSent" role="tabpanel">
            <div id="agGridSent" class="ag-theme-balham" style="height:400px;width:100%;"></div>
          </div>
        </div>
      </div>



      <!-- End fixed bottom info bar -->

      <footer class="footer text-center">© 2025 Harmony by HansolPNS</footer>
    </div>
    <!-- Fixed bottom info bar -->

  </div> <!-- page-wrapper -->
  </div> <!-- main-wrapper -->

  <input type="hidden" id="spring_profile" value="dev" />
  <input type="hidden" id="loginUserId" value="marusys" />
  <input type="hidden" id="session_USER_ID" value="marusys" />
  <input type="hidden" id="session_USER_NM" value="시스템관리" />
  <input type="hidden" id="session_MANDT" value="100" />
  <input type="hidden" id="session_MANDT_NM" value="지류유통" />
  <input type="hidden" id="session_BUKRS" value="M200" />
  <input type="hidden" id="session_BUKRS_NM" value="PNS지류유통" />
  <input type="hidden" id="session_VKGRP" value="" />
  <input type="hidden" id="session_VKGRP_NM" value="" />
  <input type="hidden" id="session_MOBILE" value="" />
  <input type="hidden" id="session_EMAIL" value="" />
  <input type="hidden" id="session_KOSTL" value="" />
  <input type="hidden" id="session_ADMIN_YN" value="N" />
  <input type="hidden" id="session_LOGIN_DT" value="2025-07-15 19:30:24" />
  <input type="hidden" id="session_SMART_ID" value="" />
  <input type="hidden" id="session_SMART_PASSWORD" value="" />
  <input type="hidden" id="session_USER_IP" value="0:0:0:0:0:0:0:1" />
  <input type="hidden" id="session_SESSION_ID" value="" />
  <input type="hidden" id="session_FIRST_TOPMENU" value="" />
  <input type="hidden" id="session_MM" value="MM999" />
  <input type="hidden" id="session_SD" value="SD999" />
  <input type="hidden" id="session_CO" value="CO999" />
  <input type="hidden" id="session_FI" value="FI999" />
  <input type="hidden" id="session_CM" value="CM999" />
  <input type="hidden" id="session_IN_IP_YN" value="N" />
  <input type="hidden" id="session_UPPER_BU" value="" />
  <input type="hidden" id="session_UPPER_NAME" value="" />

  <input id="message" type="hidden" value="" />

  <!-- Modal Request Popup -->



  <script>
    // Mock request data
    const mockRequests = [
      {
        id: 'REQ001',
        title: '인쇄 자재 구매',
        date: '2025-07-18',
        status: '대기중',
        type: '보낸 요청',
        approvers: [
          { name: '박민수', avatar: 'PM', status: 'pending' },
          { name: '이영희', avatar: 'LY', status: 'approved' },
          { name: '김철수', avatar: 'KC', status: 'pending' }
        ],
        canApprove: false,
        attachment: { name: '견적서.pdf', size: '1.2MB' }
      },
      {
        id: 'REQ002',
        title: '기계 수리 요청',
        date: '2025-07-19',
        status: '대기중',
        type: '승인 필요',
        approvers: [
          { name: 'marusys', avatar: 'MS', status: 'pending' },
          { name: '최지훈', avatar: 'CJ', status: 'pending' },
          { name: '이영희', avatar: 'LY', status: 'approved' },
          { name: '김영수', avatar: 'KY', status: 'rejected' }
        ],
        canApprove: true
      },
      {
        id: 'REQ003',
        title: '야근 제안',
        date: '2025-07-20',
        status: '승인됨',
        type: '보낸 요청',
        approvers: [
          { name: '박민수', avatar: 'PM', status: 'approved' },
          { name: '이영희', avatar: 'LY', status: 'approved' }
        ],
        canApprove: false
      },
      {
        id: 'REQ004',
        title: '휴가 신청',
        date: '2025-07-17',
        status: '반려됨',
        type: '승인 필요',
        approvers: [
          { name: 'marusys', avatar: 'MS', status: 'rejected' },
          { name: '최지훈', avatar: 'CJ', status: 'pending' }
        ],
        canApprove: true
      }
    ];

    // AG Grid column definitions
    const requestColumnDefs = [
      { headerName: '요청 번호', field: 'id', minWidth: 100, cellClass: 'ag-left-cell' },
      { headerName: '제목', field: 'title', minWidth: 180, cellClass: 'ag-left-cell' },
      { headerName: '요청일시', field: 'date', minWidth: 120, cellClass: 'ag-left-cell' },
      {
        headerName: '상태',
        field: 'status',
        minWidth: 110,
        cellClass: 'ag-left-cell',
        cellRenderer: function (params) {
          const status = params.value;
          let color = '#4a90e2', bg = '#eaf3fb', text = '대기중';
          if (status === '승인됨') { color = '#2ecc40'; bg = '#eafbe7'; text = '승인됨'; }
          else if (status === '반려됨') { color = '#e74c3c'; bg = '#fdeaea'; text = '반려됨'; }
          return `<span style="display:inline-block;padding:0px 12px;border-radius:5px;font-size:13px;font-weight:500;color:${color};background:${bg};min-width:70px;">${text}</span>`;
        }
      },
      {
        headerName: '결재자',
        field: 'approvers',
        minWidth: 428,
        cellClass: 'ag-center-cell',
        cellRenderer: function (params) {
          const approvers = params.value || [];
          return `<div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center;">
            ${approvers.map(app => `
              <div style="position:relative;width:36px;height:36px;display:flex;align-items:center;justify-content:center;">
                <span style="width:36px;height:36px;border-radius:50%;background:#e3e7ed;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#2563eb;font-size:15px;">${app.avatar}</span>
                <span style="position:absolute;bottom:-8px;right:-5px;">
                  ${app.status === 'approved' ? '<i class="fa fa-check-circle" style="color:#2ecc40;font-size:16px;" title="승인됨"></i>' : app.status === 'pending' ? '<i class="fa fa-clock" style="color:#f1c40f;font-size:16px;" title="대기중"></i>' : '<i class="fa fa-times-circle" style="color:#e74c3c;font-size:16px;" title="반려됨"></i>'}
                </span>
              </div>
            `).join('')}
          </div>`;
        }
      },
      {
        headerName: '승인/반려',
        field: 'approveActions',
        minWidth: 160,
        cellRenderer: function (params) {
          const data = params.data;
          // Nếu đã duyệt hoặc đã từ chối thì show trạng thái
          if (data.status === '승인됨') {
            return `<span style="display:inline-block;padding:0px 12px;border-radius:5px;font-size:13px;font-weight:500;color:#2ecc40;background:#eafbe7;min-width:70px;">승인됨</span>`;
          } else if (data.status === '반려됨') {
            return `<span style="display:inline-block;padding:0px 12px;border-radius:5px;font-size:13px;font-weight:500;color:#e74c3c;background:#fdeaea;min-width:70px;">반려됨</span>`;
          } else if (data.canApprove) {
            return `
              <button class='btn btn-success btn-sm' style='margin-right:6px;border-radius:6px;padding:0px 8px;background-color:#2ecc40;border-color:#2ecc40;color:#fff;' title='승인' onclick="alert('승인: ${data.id}')"><i class='fa fa-check'></i> <span style='font-weight:500;'>승인</span></button>
              <button class='btn btn-danger btn-sm' style='border-radius:6px;padding:0px 8px;background-color:#e53e3e;border-color:#e53e3e;color:#fff;' title='반려' onclick="alert('반려: ${data.id}')"><i class='fa fa-times'></i> <span style='font-weight:500;'>반려</span></button>
            `;
          } else {
            return `<span style="color:#888;">승인 불가</span>`;
          }
        }
      },
      {
        headerName: '상세보기',
        field: 'viewDetail',
        minWidth: 100,
        cellRenderer: function (params) {
          const data = params.data;
          return `<button class='btn btn-outline-secondary btn-sm' style='border-radius:6px;padding:2px 6px;' title='상세보기' onclick="showRequestDetail(${JSON.stringify(data).replace(/"/g, '&quot;')})"><i class='fa fa-eye'></i></button>`;
        }
      }
    ];

    // AG Grid options
    function getGridOptions(rowData) {
      return {
        columnDefs: requestColumnDefs,
        rowData: rowData,
        defaultColDef: {
          resizable: true,
          sortable: true,
          filter: true,
          minWidth: 60,
          cellClass: 'ag-left-cell',
          cellStyle: { display: 'flex', alignItems: 'center', justifyContent: 'flex-start', height: '100%' }
        },
        suppressRowClickSelection: true,
        animateRows: true,
        domLayout: 'autoHeight',
        getRowHeight: function (params) {
          return 52; // tăng chiều cao dòng
        }
      };
    }

    // Phân loại request cho từng tab
    function filterRequests(type) {
      if (type === 'all') return mockRequests;
      if (type === 'approve') return mockRequests.filter(r => r.type === '승인 필요');
      if (type === 'sent') return mockRequests.filter(r => r.type === '보낸 요청');
      return [];
    }

    // Khởi tạo AG Grid khi DOM ready
    document.addEventListener('DOMContentLoaded', function () {
      new agGrid.Grid(document.getElementById('agGridAll'), getGridOptions(filterRequests('all')));
      new agGrid.Grid(document.getElementById('agGridApprove'), getGridOptions(filterRequests('approve')));
      new agGrid.Grid(document.getElementById('agGridSent'), getGridOptions(filterRequests('sent')));
    });
  </script>

  <!-- 타임리프 사용을 위해서 th:inline="javascript" -->
  <!-- ...existing code... -->
  <script>
    $(function () {
      var path = window.location.pathname;
      $('#sidebarnav a[href="' + path + '"]').each(function () {
        $(this).parent('li').addClass('active');
        $(this).closest('ul').addClass('in show').attr('aria-expanded', 'true');
        $(this).closest('li').addClass('active');
        $(this).attr('aria-expanded', 'true');
      });
    });
  </script>
  <script>
    // Set user info (avatar, name, org, date)
    function getInitials(name) {
      return name.split(' ').map(w => w[0]).join('').toUpperCase();
    }
    const userName = $('#session_USER_NM').val() || 'Nguyễn Hữu Quang';
    const userOrg = 'Joey Nguyen'; // Có thể lấy từ session nếu có
    const userDept = 'Web'; // Có thể lấy từ session nếu có
    const userDate = new Date().toISOString().slice(0, 10);
    $('#userAvatar').text(getInitials(userName));
    $('#userName').text(userName);
    $('#userOrg').text(userOrg);
    $('#userDept').text(userDept);
    $('#userDate').text(userDate.replace(/-/g, '/'));

    // Approver logic
    let approvers = ["박민수", "이영희"]; // 기본 결재자
    function renderApprovers() {
      $('#approverList').html(approvers.map((name, idx) =>
        `<div style="display:flex;align-items:center;background:#f0f4fa;border-radius:20px;padding:4px 12px 4px 6px;box-shadow:0 1px 4px #0001;gap:7px;">
      <div style='width:28px;height:28px;border-radius:50%;background:#2563eb22;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;color:#2563eb;'><i class='fa fa-user'></i></div>
      <span style='font-size:14px;color:#222;'>${name}</span>
      <span style='cursor:pointer;color:#f00;font-size:16px;margin-left:4px;' onclick='removeApprover(${idx})' title='삭제'><i class='fa fa-times-circle'></i></span>
    </div>`
      ).join(''));
    }
    window.removeApprover = function (idx) {
      approvers.splice(idx, 1);
      renderApprovers();
    }
    // Approver select show/hide logic
    $('#showApproverSelect').on('click', function () {
      $('#approverSelectWrap').show();
      $('#approverSelect').focus();
    });
    $('#addApprover').on('click', function () {
      const val = $('#approverSelect').val();
      if (val && !approvers.includes(val)) {
        approvers.push(val);
        renderApprovers();
      }
      $('#approverSelectWrap').hide();
      $('#approverSelect').val('');
    });
    $(document).on('click', function (e) {
      if (!$(e.target).closest('#approverSelectWrap, #showApproverSelect').length) {
        $('#approverSelectWrap').hide();
      }
    });
    // CC logic
    let ccs = ["김영수", "박지은"]; // 기본 참조자
    function renderCCs() {
      $('#ccList').html(ccs.map((name, idx) =>
        `<div style="display:flex;align-items:center;background:#f6f0fa;border-radius:20px;padding:4px 12px 4px 6px;box-shadow:0 1px 4px #0001;gap:7px;">
      <div style='width:28px;height:28px;border-radius:50%;background:#a259e622;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;color:#a259e6;'><i class='fa fa-user'></i></div>
      <span style='font-size:14px;color:#222;'>${name}</span>
      <span style='cursor:pointer;color:#f00;font-size:16px;margin-left:4px;' onclick='removeCC(${idx})' title='삭제'><i class='fa fa-times-circle'></i></span>
    </div>`
      ).join(''));
    }
    window.removeCC = function (idx) {
      ccs.splice(idx, 1);
      renderCCs();
    }
    // CC select show/hide logic
    $('#showCCSelect').on('click', function () {
      $('#ccSelectWrap').show();
      $('#ccSelect').focus();
    });
    $('#addCC').on('click', function () {
      const val = $('#ccSelect').val();
      if (val && !ccs.includes(val)) {
        ccs.push(val);
        renderCCs();
      }
      $('#ccSelectWrap').hide();
      $('#ccSelect').val('');
    });
    $(document).on('click', function (e) {
      if (!$(e.target).closest('#ccSelectWrap, #showCCSelect').length) {
        $('#ccSelectWrap').hide();
      }
    });
    // 기본 결재자/참조자 렌더링
    $(document).ready(function () {
      renderApprovers();
      renderCCs();
    });
  </script>
</body>
<!-- Modal Request Detail Popup -->
<div class="modal fade" id="requestDetailModal" tabindex="-1" role="dialog" aria-labelledby="requestDetailModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content" style=" overflow: hidden;">
      <div class="modal-header" style="border-bottom: 1px solid #f0f0f0;">
        <h5 class="modal-title" id="requestDetailModalLabel"><i class="fa fa-eye"></i> 결재 상세</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" style="background: #f7f9fb; padding: 0;">
        <div style="background: #fff; padding: 24px 12px 12px 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style=" display: flex; align-items: center; gap: 16px;">
              <div
                style="width: 50px; height: 50px; background: #e3e7ed; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; color: #4a5568;">
                <span id="userAvatar">김</span>
              </div>
              <div>
                <div style="font-size: 18px; font-weight: bold; color: #222;" id="userName">김철수</div>
                <div style="font-size: 13px; color: #666;">조직: <span id="userDept">웹팀</span></div>

              </div>

            </div>


            <div>
              <div style="font-size: 13px; color: #666; margin-top: 4px;">요청일시: <span id="userDate">16:23 2025/07/21
                </span>
              </div>
              <div style="float: right; display: flex; gap: 5px;">
                <div for="priority" style="font-size: 13px; color: #666; margin-top: 4px;">우선순위:</div>
                <select id="priority" name="priority"
                  style="padding: 0px 12px; border-radius: 5px; border: 1px solid #e3e7ed; font-size: 15px; font-weight: 500; background: #f7f9fb; color: #222; outline: none; appearance: none; position: relative; margin-bottom: 0;">
                  <option value="low" data-color="#38b2ac">낮음</option>
                  <option value="medium" data-color="#f6ad55">보통</option>
                  <option value="high" data-color="#f56565">높음</option>
                  <option value="urgent" data-color="#e53e3e">긴급</option>
                </select>
              </div>

            </div>

          </div>
          <div class="form-group">
            <label for="detailTitleInput" style="font-size: 14px; font-weight: bold;">제목 <span
                style="color:red">*</span></label>
            <input type="text" class="form-control form-control-sm" id="detailTitleInput" name="title" readonly>
          </div>
          <div class="form-group">
            <label for="detailContentInput" style="font-size: 14px; font-weight: bold;">내용 <span
                style="color:red">*</span></label>
            <textarea class="form-control form-control-sm" id="detailContentInput" name="content" rows="3"
              readonly></textarea>
          </div>
          <div class="form-group">
            <label for="detailAttachmentInput" style="font-size: 14px; font-weight: bold;">첨부파일</label>
            <input type="text" class="form-control form-control-sm" id="detailAttachmentInput" name="attachment"
              readonly>
              <div id="attachmentMarusys" style="display: none;">
                            <div id="drop-area" 
              style=" border: 2px dashed #bdbdbd; border-radius: 12px; background: #fff; padding: 32px 0; text-align: center; margin-top: 8px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s;">
              <span style="font-size: 16px; color: #444;">여기로 파일을 끌어다 놓거나 <span id="browseFile"
                  style="color: #2563eb; text-decoration: underline; cursor: pointer;">파일 선택</span></span>
              <div style="font-size: 12px; color: #888; margin-top: 8px;">최대 크기: 5MB (PDF, DOCX, XLSX, JPG, PNG 지원)
              </div>
              <input type="file" id="attachment" name="attachment" style="display: none;"
                accept=".pdf,.docx,.xlsx,.jpg,.jpeg,.png" />
            </div>

              </div>


          </div>

          <div class="row" style="padding: 0;">
            <div class="col-12" style="padding: 0; padding-right: 5px;">
              <!-- History -->
              <div style="margin-bottom: 5px;">
                <div style="font-weight: bold; font-size: 15px; color: #222; margin-bottom:6px;">처리 이력</div>
                <div id="detailHistory"
                  style="background:#f7f7f7;border-radius:8px;padding:12px;font-size:14px;color:#444;max-height:200px;overflow:auto;">
                </div>
              </div>
                              <div class="input-group">
                  <input type="text" id="commentInput" class="form-control form-control-sm" placeholder="댓글을 입력하세요...">
                  <div class="input-group-append">
                    <button class="btn btn-harmony-blue btn-sm" id="addCommentBtn" type="button"><i
                        class="fa fa-paper-plane"></i> 등록</button>
                  </div>
                </div>

            </div>





          </div>



          <div>
            <div class="approval-line-wrap" style="margin-top:18px;">
              <div class="d-flex align-items-center mb-2" style="gap:12px; justify-content: space-between; ">
                <div>
                  <button id="applyDefaultLine" type="button" class="btn btn-harmony-blue btn-sm"><i
                      class="fa fa-sync"></i> 기본
                    결재선 적용</button>
                  <button id="saveDefaultLine" type="button" class="btn btn-outline-secondary btn-sm"><i
                      class="fa fa-save"></i>
                    결재선 저장</button>

                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <!-- <div class="form-check form-switch ml-2">
                    <input class="form-check-input" type="checkbox" id="parallelApproval" style="display: none;">
                    <label id="parallelApprovalWrapper" class="form-check-label" for="parallelApproval"
                      style="font-size:14px;">병렬 결재</label>

                  </div> -->
                  <button id="addApprovalRow" type="button" class="btn btn-outline-primary btn-sm"
                    style="border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:18px;border:none;"><i
                      class="fa fa-plus"></i></button>


                </div>


              </div>
              <div id="approvalGrid" class="ag-theme-balham"
                style="height: 300px; width: 100%; background: #fff; border-radius: 12px; box-shadow:0 1px 8px #0001; font-size:15px;">
              </div>

              <!-- User Search Popup -->
              <div id="userSearchModal" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title"><i class="fa fa-search"></i> 결재자 검색</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                          aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                      <input type="text" id="userSearchInput" class="form-control mb-2"
                        placeholder="이름, 아이디, 직책으로 검색..." style="border:none;box-shadow:none;">
                      <div id="userSearchList"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>

        </div>
      </div>
      <div class="modal-footer" style="border-top: 1px solid #f0f0f0;">
        <div id="zedd"></div>
        <button type="button" class="btn btn-success btn-sm" id="approveBtn"
          style="background-color:#2ecc40;border-color:#2ecc40;color:#fff;"><i class="fa fa-check"></i>
          승인</button>
        <button type="button" class="btn btn-danger btn-sm" id="rejectBtn"
          style="background-color:#e53e3e;border-color:#e53e3e;color:#fff;"><i class="fa fa-times" style=""></i>
          반려</button>
      </div>
      </form>
    </div>
  </div>
  <script>
    // Show request detail popup
    function showRequestDetail(data) {
      // Fill all fields in the form with request data
      $('#detailUserAvatar').text(data.id ? data.id.slice(-2) : 'AV');
      $('#detailUserName').text(data.title || '김철수');
      $('#detailUserOrg').text(data.type || '홍길동');
      $('#detailUserDept').text(data.department || '웹팀');
      $('#detailUserDate').text(data.date || '2025/07/21');
      $('#detailTitleInput').val(data.title || '요청 제목');
      $('#detailContentInput').val('요청 내용 예시...');
      $('#detailPriorityInput').val(data.priority || '보통');
      $('#detailDepartmentInput').val(data.department || '웹팀');
      // 첨부파일 mock UI
      let fileHtml = '';
      if (data.attachment && data.attachment.name) {
        fileHtml = `
          <div style="display:flex;align-items:center;gap:10px;background:#f7f7f7;border-radius:8px;padding:8px 14px;margin-bottom:6px;">
            <i class="fa fa-file" style="color:#2563eb;font-size:18px;"></i>
            <span style="font-size:14px;color:#222;font-weight:500;">${data.attachment.name}</span>
            <span style="font-size:12px;color:#888;">${data.attachment.size}</span>
            <button class="btn btn-outline-secondary btn-sm" style="border-radius:6px;padding:2px 8px;" onclick="alert('다운로드: ${data.attachment.name}')"><i class="fa fa-download"></i> 다운로드</button>
          </div>
        `;
      } else  {
        fileHtml = `<span id="hehee" style="font-size:14px;color:#888;">첨부파일 없음</span>`;
      }
      $('#detailAttachmentInput').replaceWith(`<div id="detailAttachmentInput">${fileHtml}</div>`);
      // Approvers: show trạng thái từng người
      $('#detailApproverList').html((data.approvers || []).map(app => {
        let statusHtml = '';
        if (app.status === 'approved') {
          statusHtml = `<span style='margin-left:6px;color:#2ecc40;font-weight:500;'><i class='fa fa-check-circle'></i> </span>`;
        } else if (app.status === 'pending') {
          statusHtml = `<span style='margin-left:6px;color:#f1c40f;font-weight:500;'><i class='fa fa-clock'></i> </span>`;
        } else if (app.status === 'rejected') {
          statusHtml = `<span style='margin-left:6px;color:#e74c3c;font-weight:500;'><i class='fa fa-times-circle'></i> </span>`;
        }
        return `<div style="display:flex;align-items:center;background:#f0f4fa;border-radius:20px;padding:4px 12px 4px 6px;box-shadow:0 1px 4px #0001;gap:7px;">
          <div style='width:28px;height:28px;border-radius:50%;background:#2563eb22;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;color:#2563eb;'>${app.avatar}</div>
          <span style='font-size:14px;color:#222;'>${app.name}</span>
          ${statusHtml}
        </div>`;
      }).join(''));

      // CCs: show luôn dữ liệu nếu có
      $('#detailCCList').html((data.ccs || []).map(name =>
        `<div style="display:flex;align-items:center;background:#f6f0fa;border-radius:20px;padding:4px 12px 4px 6px;box-shadow:0 1px 4px #0001;gap:7px;">
          <div style='width:28px;height:28px;border-radius:50%;background:#a259e622;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;color:#a259e6;'><i class='fa fa-user'></i></div>
          <span style='font-size:14px;color:#222;'>${name}</span>
        </div>`
      ).join(''));
      // Timeline style for history
      const historyItems = [
        { date: '18:05 2025-07-18 ', text: '요청 생성', user: '김철수', type: 'create' },
        { date: '15:02 2025-07-19', text: '이영희 승인', user: '이영희', type: 'approve' },
        { date: '13:08 2025-07-20', text: '부서로 전달', user: '웹팀', type: 'send' }
      ];
      $('#detailHistory').html(`
        <ul class="timeline-list" style="list-style:none;padding:0;margin:0;">
          ${historyItems.map((item, idx) => `
            <li style="position:relative;padding-left:32px;margin-bottom:18px; ">
              <span style="position:absolute;left:0;top:0;width:18px;height:18px;border-radius:50%;background:${item.type === 'approve' ? '#2ecc40' : item.type === 'create' ? '#2563eb' : '#888'};display:flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:bold;">${idx + 1}</span>
             <div style="display:flex;gap:4px;">
              <div style="font-size:13px;color:#2563eb;">${item.user}</div>
              <div style="font-size:13px;color:#888;">${item.date}</div>
              </div>
              
              <div style="font-size:15px;color:#222;font-weight:500;">${item.text}</div>
              
              ${idx < historyItems.length - 1 ? `<span style='position:absolute;left:8px;top:18px;width:2px;height:calc(100% - 18px);background:#e3e7ed;'></span>` : ''}
            </li>
          `).join('')}
        </ul>
      `);
      // Modern comment style
      const comments = [
        { user: '김철수', text: '빠른 처리 부탁드립니다.', time: '2025-07-18 10:12' },
        { user: '이영희', text: '승인 완료.', time: '2025-07-19 14:22' }
      ];
      $('#detailComments').html(`
        <div style="display:flex;flex-direction:column;gap:12px;">
          ${comments.map(c => `
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="width:32px;height:32px;border-radius:50%;background:#e3e7ed;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#2563eb;font-size:15px;">${c.user.split(' ').map(w => w[0]).join('').toUpperCase()}</div>
              <div style="background:#fff;border-radius:8px;padding:10px 14px;box-shadow:0 1px 4px #0001;min-width:120px;">
                <div style="display:flex;justify-content:space-between;align-items:center; gap: 20px;">
                  <div style="font-size:14px;font-weight:500;color:#2563eb;">${c.user}</div>
                  <div style="font-size:12px;color:#888;">${c.time}</div>
                  </div>
                
                <div style="font-size:14px;color:#222;margin-top:2px;">${c.text}</div>
                
              </div>
            </div>
          `).join('')}
        </div>
      `);
      // Add new comment
      $('#addCommentBtn').off('click').on('click', function () {
        const val = $('#commentInput').val();
        if (val) {
          const now = new Date();
          const time = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0') + ' ' + String(now.getHours()).padStart(2, '0') + ':' + String(now.getMinutes()).padStart(2, '0');
          const user = '나';
          $('#detailComments').append(`
            <div style=\"display:flex;align-items:flex-start;gap:10px;margin-top:12px;\">
              <div style=\"width:32px;height:32px;border-radius:50%;background:#e3e7ed;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#2563eb;font-size:15px;\">${user[0]}</div>
              <div style=\"background:#fff;border-radius:8px;padding:10px 14px;box-shadow:0 1px 4px #0001;min-width:120px;\">
                <div style=\"font-size:14px;font-weight:500;color:#2563eb;\">${user}</div>
                <div style=\"font-size:14px;color:#222;margin-top:2px;\">${val}</div>
                <div style=\"font-size:12px;color:#888;margin-top:4px;\">${time}</div>
              </div>
            </div>
          `);
          $('#commentInput').val('');
        }
      });
      $('#approveBtn').off('click').on('click', function () { alert('승인: ' + data.id); });
      $('#rejectBtn').off('click').on('click', function () { alert('반려: ' + data.id); });
      $('#addCommentBtn').off('click').on('click', function () {
        const val = $('#commentInput').val();
        if (val) {
          $('#detailComments').append(`<div><b>나:</b> ${val}</div>`);
          $('#commentInput').val('');
        }
      });
      $('#requestDetailModal').modal('show');
    }
  </script>

  <script>
    $(document).ready(function () {
      // Approval Line Component
      let isEdit = false; // 상태 변수
      const mockUsers = [
        { id: 'u001', name: '김철수', title: '팀장', dept: '웹팀' },
        { id: 'u002', name: '박민수', title: '과장', dept: '영업팀' },
        { id: 'u003', name: '이영희', title: '대리', dept: '기획팀' },
        { id: 'u004', name: '최지훈', title: '사원', dept: '개발팀' },
        { id: 'u005', name: '정수진', title: '부장', dept: '인사팀' },
        { id: 'u006', name: '조현우', title: '팀장', dept: '마케팅팀' },
        { id: 'u007', name: '한지민', title: '과장', dept: '재무팀' },
        { id: 'u008', name: '윤아름', title: '대리', dept: '운영팀' },
        { id: 'u009', name: '오세훈', title: '사원', dept: '고객지원' },
        { id: 'u010', name: '신동엽', title: '부장', dept: '기술팀' }
      ];
      const lineTypes = [
        { value: '기안', label: '기안' },
        { value: '결재', label: '결재' },
        { value: '병렬결재', label: '병렬결재' },
        { value: '합의', label: '합의' },
        { value: '병렬합의', label: '병렬합의' },
        { value: '통보', label: '통보' },
        { value: '확정', label: '확정' }
      ];
      const defaultLine = [
        { order: 0, type: '기안', user: mockUsers[0], dept: mockUsers[0].dept }
      ];
      let approvalLine = JSON.parse(JSON.stringify(defaultLine));
      let approvalGridApi = null;

      // 동적 컬럼 생성 함수
      function getApprovalColumnDefs() {
        return [
          {
            headerName: '순번',
            field: 'order',
            minWidth: 60,
            flex: 1,
            valueGetter: params => params.node.rowIndex,
            cellClass: 'ag-center-cell',
            suppressMenu: true
          },
          {
            headerName: '유형',
            field: 'type',
            minWidth: 100,
            flex: 2,
            cellRenderer: params => {
              if (!isEdit) return `<span>${params.value}</span>`;
              const options = lineTypes.map(t => `<option value='${t.value}' ${params.value === t.value ? 'selected' : ''}>${t.label}</option>`).join('');
              return `<select class='form-control form-control-sm approval-type-select' style='border:none;box-shadow:none;height:36px;text-align:center;'>${options}</select>`;
            },
            editable: isEdit,
            cellClass: 'ag-center-cell'
          },
          {
            headerName: '결재자',
            field: 'user',
            minWidth: 180,
            flex: 3,
            cellRenderer: params => {
              const user = params.value;
              let display = user ? `${user.name} (${user.title}) [${user.id}]` : '';
              if (!isEdit) {
                return `<span>${display}</span>`;
              }
              return `<div style='display:flex;align-items:center;gap:6px;height:36px;'>
              <input type='text' class='form-control form-control-sm approval-user-input' value='${display}' readonly style='background:#f7f9fb;width:120px;border:none;box-shadow:none;height:36px;text-align:center;'>
              <button class='btn btn-outline-secondary btn-sm search-user-btn' title='검색' style='border:none;height:36px;'><i class='fa fa-search'></i></button>
            </div>`;
            },
            editable: false,
            cellClass: 'ag-center-cell'
          },
          {
            headerName: '직책',
            field: 'user.title',
            minWidth: 100,
            flex: 2,
            valueGetter: params => params.data.user ? params.data.user.title : '',
            cellClass: 'ag-center-cell',
            editable: false
          },
          {
            headerName: '부서',
            field: 'dept',
            minWidth: 120,
            flex: 2,
            cellRenderer: params => {
              if (!isEdit) return `<span>${params.value || ''}</span>`;
              return `<input type='text' class='form-control form-control-sm approval-dept-input' value='${params.value || ''}' style='background:#f7f9fb;border:none;box-shadow:none;height:36px;text-align:center;'>`;
            },
            editable: isEdit,
            cellClass: 'ag-center-cell'
          },
          // [ADD] Approval Status column
          {
            headerName: '상태',
            field: 'status',
            minWidth: 90,
            flex: 1,
            cellRenderer: params => {
              // status: 'approved', 'pending', 'rejected' (mock logic)
              let status = params.data && params.data.user && params.data.user.status ? params.data.user.status : 'pending';
              let color = '#f1c40f', icon = 'fa-clock', text = '대기중';
              if (status === 'approved') { color = '#2ecc40'; icon = 'fa-check-circle'; text = '승인'; }
              else if (status === 'rejected') { color = '#e74c3c'; icon = 'fa-times-circle'; text = '반려'; }
              return `<span style="display:inline-flex;align-items:center;gap:4px;font-size:13px;font-weight:500;color:${color};"><i class="fa ${icon}"></i> ${text}</span>`;
            },
            cellClass: 'ag-center-cell',
            editable: false
          },
          ...(isEdit ? [{
            headerName: '',
            field: 'actions',
            minWidth: 120,
            flex: 2,
            cellRenderer: params => {
              return `<div style='display:flex;align-items:center;gap:4px;justify-content:flex-end;height:36px;'>
              <i class='fa fa-trash remove-row-btn' style="color: red;cursor:pointer"></i>
              <button class='btn btn-outline-dark btn-sm move-up-btn' title='위로' style='border:none;height:36px;'><i class='fa fa-arrow-up'></i></button>
              <button class='btn btn-outline-dark btn-sm move-down-btn' title='아래로' style='border:none;height:36px;'><i class='fa fa-arrow-down'></i></button>
            </div>`;
            },
            suppressMenu: true,
            suppressSorting: true,
            cellClass: 'ag-center-cell'
          }] : [])
        ];
      }

      function renderApprovalGrid() {
        const gridDiv = document.getElementById('approvalGrid');
        gridDiv.innerHTML = '';
        gridDiv.style.fontSize = '13px'; // Reduce font size for grid text
        gridDiv.style.fontWeight = 'normal'; // Remove bold font from grid text
        const gridOptions = {
          columnDefs: getApprovalColumnDefs(),
          rowData: approvalLine,
          defaultColDef: {
            resizable: true,
            sortable: false,
            filter: false,
            editable: false,
            minWidth: 60,
            flex: 1,
            cellClass: 'ag-center-cell',
            cellStyle: { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%' }
          },
          suppressRowClickSelection: true,
          rowSelection: 'single',
          animateRows: true,
          getRowHeight: function (params) {
            return 52;
          },
          onGridReady: function (params) {
            approvalGridApi = params.api;
          },
          onCellClicked: function (params) {
            const rowIdx = params.node.rowIndex;
            if (isEdit && params.colDef.field === 'add') {
              addApprovalRow(rowIdx + 1);
            }
          },
          onCellEditingStopped: function (params) {
            // ...handle cell edit if needed...
          }
        };
        new agGrid.Grid(gridDiv, gridOptions);
      }

      function addApprovalRow(idx) {
        approvalLine.splice(idx, 0, { order: idx, type: '결재', user: null, dept: '' });
        renderApprovalGrid();
      }

      // 버튼 상태에 따라 show/hide
      function updateApprovalUI() {
        if (isEdit) {
          $('#applyDefaultLine').show();
          $('#saveDefaultLine').show();
          $('#addApprovalRow').show();
          $("#parallelApprovalWrapper").show();

          $('#detailTitleInput').prop('readonly', false);
          $('#detailContentInput').prop('readonly', false);
          document.getElementById('attachmentMarusys').style.display = 'block';
                   document.getElementById('hehee').style.display = 'block';

        } else {
          $('#applyDefaultLine').hide();
          $('#saveDefaultLine').hide();
          $('#addApprovalRow').hide();
          $("#parallelApprovalWrapper").hide();
          ;
          $('#detailTitleInput').prop('readonly', true);
          $('#detailContentInput').prop('readonly', true);
          $('#attachmentMarusys').css('display', 'none');
          $('#hehee').css('display', 'none');



        }
        renderApprovalGrid();
        // Edit/Save 버튼 텍스트 변경
        if (isEdit) {
          $('#toggleEditBtn').html('<i class="fa fa-save"></i> 저장');
          if ($('#cancelEditBtn').length === 0) {
            $('#toggleEditBtn').after('<button id="cancelEditBtn" type="button" class="btn btn-outline-secondary btn-sm ml-2"><i class="fa fa-times"></i> 취소</button>');
          }
          $('#cancelEditBtn').show();
        } else {
          $('#toggleEditBtn').html('<i class="fa fa-edit"></i> 수정');
          $('#cancelEditBtn').remove();
        }
      }

      // Edit/Save 버튼 추가
      if ($('#toggleEditBtn').length === 0) {
        $('#zedd').first().prepend('<button id="toggleEditBtn" type="button" class="btn btn-outline-dark btn-sm mr-2">수정</button>');
      }
      $('#toggleEditBtn').off('click').on('click', function () {
        if (isEdit) {
          // 저장 로직 필요시 추가
          toastr.success('저장되었습니다!');
        }
        isEdit = !isEdit;
        updateApprovalUI();
      });
      $(document).off('click', '#cancelEditBtn').on('click', '#cancelEditBtn', function () {
        isEdit = false;
        updateApprovalUI();
      });

      // 이벤트 핸들러들 (edit 모드에서만 동작)
      $('#addApprovalRow').off('click').on('click', function () {
        if (isEdit) addApprovalRow(approvalLine.length);
      });
      $(document).off('click', '.remove-row-btn').on('click', '.remove-row-btn', function () {
        if (!isEdit) return;
        const idx = getRowIndexFromBtn(this);
        if (idx !== null) {
          approvalLine.splice(idx, 1);
          renderApprovalGrid();
        }
      });
      $(document).off('click', '.move-up-btn').on('click', '.move-up-btn', function () {
        if (!isEdit) return;
        const idx = getRowIndexFromBtn(this);
        if (idx > 0) {
          [approvalLine[idx - 1], approvalLine[idx]] = [approvalLine[idx], approvalLine[idx - 1]];
          renderApprovalGrid();
        }
      });
      $(document).off('click', '.move-down-btn').on('click', '.move-down-btn', function () {
        if (!isEdit) return;
        const idx = getRowIndexFromBtn(this);
        if (idx < approvalLine.length - 1) {
          [approvalLine[idx + 1], approvalLine[idx]] = [approvalLine[idx], approvalLine[idx + 1]];
          renderApprovalGrid();
        }
      });
      $(document).off('change', '.approval-type-select').on('change', '.approval-type-select', function () {
        if (!isEdit) return;
        const idx = getRowIndexFromBtn(this);
        if (idx !== null) {
          approvalLine[idx].type = $(this).val();
          renderApprovalGrid();
        }
      });
      $(document).off('change', '.approval-dept-input').on('change', '.approval-dept-input', function () {
        if (!isEdit) return;
        const idx = getRowIndexFromBtn(this);
        if (idx !== null) {
          approvalLine[idx].dept = $(this).val();
        }
      });
      $(document).off('click', '.search-user-btn').on('click', '.search-user-btn', function () {
        if (!isEdit) return;
        const idx = getRowIndexFromBtn(this);
        $('#userSearchModal').data('rowIdx', idx).modal('show');
        renderUserSearchList('');
        $('#userSearchInput').val('');
      });
      $('#userSearchInput').off('input').on('input', function () {
        renderUserSearchList($(this).val());
      });
      $(document).off('click', '.user-search-item').on('click', '.user-search-item', function () {
        if (!isEdit) return;
        const idx = $('#userSearchModal').data('rowIdx');
        const userId = $(this).data('userid');
        const user = mockUsers.find(u => u.id === userId);
        if (user && idx !== null) {
          approvalLine[idx].user = user;
          approvalLine[idx].dept = user.dept;
          renderApprovalGrid();
          $('#userSearchModal').modal('hide');
        }
      });
      $('#applyDefaultLine').off('click').on('click', function () {
        if (!isEdit) return;
        approvalLine = JSON.parse(JSON.stringify(defaultLine));
        renderApprovalGrid();
      });
      $('#saveDefaultLine').off('click').on('click', function () {
        if (!isEdit) return;
        toastr.success('현재 결재선을 저장했습니다!');
      });
      $('#parallelApproval').off('change').on('change', function () {
        if (!isEdit) return;
        if (this.checked) {
          toastr.info('병렬 결재로 변경되었습니다!');
        } else {
          toastr.info('순차 결재로 변경되었습니다!');
        }
      });

      function getRowIndexFromBtn(btn) {
        const $row = $(btn).closest('.ag-row');
        if ($row.length) {
          return parseInt($row.attr('row-index'));
        }
        const val = $(btn).closest('div').find('input.approval-user-input').val();
        return approvalLine.findIndex(r => r.user && `${r.user.name} (${r.user.title}) [${r.user.id}]` === val);
      }
      function renderUserSearchList(keyword) {
        let list = mockUsers.filter(u => {
          if (!keyword) return true;
          keyword = keyword.toLowerCase();
          return u.id.toLowerCase().includes(keyword) || u.name.toLowerCase().includes(keyword) || u.title.toLowerCase().includes(keyword);
        });
        $('#userSearchList').html(list.map(u =>
          `<div class='user-search-item' data-userid='${u.id}' style='padding:8px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;'>
        <b>${u.name}</b> <span style='color:#888;'>(${u.title})</span> <span style='color:#2563eb;'>[${u.id}]</span> <span style='color:#aaa;'>${u.dept}</span>
      </div>`
        ).join(''));
      }

      // 최초 UI 상태 세팅
      updateApprovalUI();
    });
  </script>

</html>